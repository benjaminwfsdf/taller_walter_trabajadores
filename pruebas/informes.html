
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orden de Trabajo</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    @media print {
      @page { size: letter; margin: 6mm 20mm; }
      body { margin: 0; padding: 0; box-shadow: none; border: none; }
      .fab { display: none !important; }
      body { background:#fff; }
    }

    :root{
      --azul:#1d3053;
      --borde:#000;
      --gris-head:#e4e4e4;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background:#f0f0f0;
      font-size: 16px;
    }

    #paper{
      width:21.59cm;
      min-height:27.94cm;
      margin:24px auto;
      background:#fff;
      border:1px solid var(--borde);
      padding:26px 28px;
    }

    .header{
      display:flex;
      justify-content:space-between;
      gap:16px;
      margin-bottom:10px;
    }
    .header-left{ display:flex; gap:14px; }
    .header-logo img{ max-height:80px; }
    .header-info{
      font-size:12px;
      line-height:1.3;
      text-transform:uppercase;
    }

    .header-right div{
      border:1px solid var(--borde);
      padding:6px 8px;
      margin-bottom:4px;
      font-size:12px;
    }
    .header-right-label{ font-weight:bold; margin-right:6px; }

    .titulo-ot{
      margin-top:4px;
      background:var(--azul);
      color:#fff;
      text-align:center;
      font-weight:bold;
      font-size:16px;
      padding:8px 0;
      text-transform:uppercase;
    }

    .tabla-datos{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .tabla-datos td{
      border:1px solid var(--borde);
      padding:6px 8px;
    }
    .label{
      font-weight:bold;
      text-transform:uppercase;
      width:95px;
      font-size:12px;
    }
    .campo{
      width:100%;
      border:none;
      font-size:15px;
      padding:5px 4px;
      outline: none;
    }
    .campo:focus {
      background-color: #f9f9f9;
    }

    .seccion-titulo{
      margin-top:14px;
      background:var(--gris-head);
      border:1px solid var(--borde);
      font-weight:bold;
      font-size:13px;
      padding:6px 8px;
      text-transform:uppercase;
    }

    .tabla-detalle{
      width:100%;
      border-collapse:collapse;
      margin-top:2px;
      font-size:13px;
    }
    .tabla-detalle th,
    .tabla-detalle td{
      border:1px solid var(--borde);
      padding:6px;
    }
    .tabla-detalle th {
      font-size:13px;
      background-color: #f5f5f5;
    }
    .tabla-detalle textarea{
      width:100%;
      border:none;
      resize:vertical;
      min-height:200px;
      font-size:15px;
      padding:8px;
      line-height: 1.4;
      outline: none;
    }
    .tabla-detalle textarea:focus {
      background-color: #f9f9f9;
    }

    .textarea-obs{
      width:100%;
      border:1px solid var(--borde);
      min-height:70px;
      padding:8px;
      margin-top:4px;
      font-size:15px;
      line-height: 1.4;
      outline: none;
    }
    .textarea-obs:focus {
      background-color: #f9f9f9;
    }

    .fila-son{
      margin-top:14px;
      display:flex;
      align-items:center;
      font-size:13px;
      gap:8px;
    }
    .fila-son input{
      flex:1;
      border:1px solid var(--borde);
      padding:6px;
      text-align:right;
      font-size:15px;
      outline: none;
    }
    .fila-son input:focus {
      background-color: #f9f9f9;
    }

    .totales-wrap{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
    }
    .totales-col{
      min-width:200px;
      font-size:13px;
    }
    .totales-row{
      display:flex;
      margin-bottom:5px;
      align-items: center;
    }
    .totales-row label{
      width:60px;
      font-weight:bold;
      text-transform:uppercase;
      font-size:12px;
    }
    .totales-row input{
      flex:1;
      border:1px solid var(--borde);
      padding:6px;
      text-align:right;
      font-size:15px;
      outline: none;
    }
    .totales-row input:focus {
      background-color: #f9f9f9;
    }

    .firmas{
      display:flex;
      justify-content:space-between;
      margin-top:40px;
      font-size:12px;
      text-transform:uppercase;
    }
    .firma-box{ width:45%; text-align:center; }
    .firma-linea{ 
      border-top:1px solid #000; 
      height:35px;
      margin-bottom:5px; 
    }

    .nota-pie{
      text-align:center;
      margin-top:12px;
      font-size:10px;
      text-transform:uppercase;
      color: #555;
    }

    .fab{
      position:fixed;
      bottom:20px;
      right:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .fab button{
      padding:12px 20px;
      border-radius:12px;
      border:2px solid #000;
      background:#fff;
      cursor:pointer;
      font-size:16px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.2s;
      color: #000;
    }
    .fab button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      background-color: #f8f8f8;
    }

    .boton-aceites {
      background: #ffcc00 !important;
      color: #000 !important;
      border-color: #ffcc00 !important;
    }
    
    .boton-aceites:hover {
      background: #e6b800 !important;
      border-color: #e6b800 !important;
    }
    
    .boton-ots-anteriores {
      background: #1d3053 !important;
      color: white !important;
      border-color: #1d3053 !important;
    }
    
    .boton-ots-anteriores:hover {
      background: #15243e !important;
      border-color: #15243e !important;
    }
    
    .boton-imprimir {
      background: #28a745 !important;
      color: white !important;
      border-color: #28a745 !important;
    }
    
    .boton-imprimir:hover {
      background: #218838 !important;
      border-color: #1e7e34 !important;
    }
    
    .boton-borrar {
      background: #dc3545 !important;
      color: white !important;
      border-color: #dc3545 !important;
    }
    
    .boton-borrar:hover {
      background: #c82333 !important;
      border-color: #bd2130 !important;
    }

    #modal-coincidencias{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    #modal-coincidencias .modal-card{
      background:#fff;
      padding:24px;
      border-radius:10px;
      width:550px;
      max-width:90vw;
      border:2px solid #000;
      max-height:85vh;
      overflow-y:auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    #modal-coincidencias h3{
      margin-top:0;
      color:#1d3053;
      font-size:22px;
      margin-bottom: 12px;
    }
    #modal-coincidencias p {
      font-size:16px;
      margin-bottom: 20px;
      color: #444;
    }
    .coincidencia-item{
      border:2px solid #ccc;
      padding:16px;
      margin-bottom:12px;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .coincidencia-item:hover{
      background-color:#f0f7ff;
      border-color:#1d3053;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(29, 48, 83, 0.1);
    }
    .coincidencia-item .fuente{
      display:inline-block;
      padding:3px 8px;
      border-radius:4px;
      font-size:14px;
      margin-left:8px;
      background:#e4e4e4;
      font-weight: bold;
    }
    .coincidencia-item .fuente-hoja1{ background:#d4edda; color:#155724; }
    .coincidencia-item .fuente-informe{ background:#d1ecf1; color:#0c5460; }
    .botones-modal{
      display:flex;
      gap:12px;
      margin-top:20px;
    }
    .botones-modal button{
      flex:1;
      padding:12px;
      border:2px solid #000;
      border-radius:6px;
      cursor:pointer;
      font-size:16px;
      font-weight: bold;
      transition: all 0.2s;
    }
    .botones-modal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .boton-crear-nuevo{
      background:#28a745;
      color:white;
      border-color:#28a745 !important;
    }
    .boton-crear-nuevo:hover {
      background:#218838;
      border-color:#1e7e34 !important;
    }
    
    ::placeholder {
      color: #888;
      font-size: 14px;
    }
    
    #lista-coincidencias {
      list-style:none; 
      padding:0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    ::-webkit-scrollbar {
      width: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .cargando {
      display: none;
      text-align: center;
      padding: 20px;
      color: #1d3053;
      font-weight: bold;
    }
    
    .cargando-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1d3053;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Indicador de detalle copiado */
    .detalle-copiado {
      background-color: #d4edda !important;
      border-color: #155724 !important;
      border-left: 6px solid #155724 !important;
    }
    
    .mensaje-exito {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      font-weight: bold;
    }
  </style>
</head>

<body>

<!-- Mensaje de éxito (aparece cuando se copia detalle) -->
<div class="mensaje-exito" id="mensajeExito">
  ✅ Detalle copiado automáticamente
</div>

<div id="paper">
  <!-- ENCABEZADO -->
  <div class="header">
    <div class="header-left">
      <div class="header-logo">
        <img src="img/logo.png" alt="Logo">
      </div>
      <div class="header-info">
        <b>WALTER ALBERTO URIOL MARIÑOS</b><br>
        REPARACIÓN DE EMISIÓN DE GASES E INYECCIÓN ELECTRÓNICA<br>
        VENTA E INSTALACIÓN DE REPUESTOS DE VEHÍCULOS<br>
        CASA MATRIZ: AV. ORIENTAL 6222<br>
        TELÉFONO: 792 1950 – CEL.: 09-619 15 93 – PEÑALOLÉN – SANTIAGO<br>
        MECÁNICA GENERAL – EMBRAGUES AJUSTES<br>
        SUCURSAL: AV. ORIENTAL 6461 – PEÑALOLÉN<br>
        VENTA DE REPUESTOS, ACCESORIOS Y LUBRICANTES<br>
        SUCURSAL: AV. ORIENTAL 6200 – PEÑALOLÉN<br>
        E-MAIL: WALTERURIOL@HOTMAIL.COM
      </div>
    </div>

    <div class="header-right">
      <div><span class="header-right-label">FECHA:</span><span id="fechaHoy"></span></div>
      <div><span class="header-right-label">N°</span><span id="otNumero"></span></div>
    </div>
  </div>

  <div class="titulo-ot">ORDEN DE TRABAJO</div>

  <!-- DATOS -->
  <table class="tabla-datos">
    <tr>
      <td class="label">Nombre del cliente:</td>
      <td colspan="3"><input id="nombreCliente" class="campo"></td>
    </tr>

    <tr>
      <td class="label">Dirección:</td>
      <td colspan="2">
        <input id="direccion" class="campo">
      </td>
      <td>
        <table style="width:100%; border-collapse:collapse;">
          <tr>
            <td class="label" style="width:65px; border:none;">Teléfono:</td>
            <td style="border:none;">
              <input id="telefono" class="campo" placeholder="Ej: +56 9 62191593">
            </td>
          </tr>
        </table>
      </td>
    </tr>

    <tr>
      <td class="label">Marca:</td>
      <td><input id="marca" class="campo"></td>

      <td class="label">Patente:</td>
      <td><input id="patente" class="campo" style="text-transform:uppercase;"></td>
    </tr>

    <tr>
      <td class="label">KM:</td>
      <td><input id="km" class="campo"></td>

      <td class="label">Modelo:</td>
      <td><input id="modelo" class="campo"></td>
    </tr>
  </table>

  <!-- DETALLE -->
  <div class="seccion-titulo">Detalle del trabajo</div>

  <table class="tabla-detalle">
    <thead>
      <tr>
        <th style="width:12%;">Cant.</th>
        <th style="width:68%;">Detalle</th>
        <th style="width:20%;">Valor</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><textarea id="cantDetalle" oninput="calcularTotales()" placeholder="&#10;&#10;"></textarea></td>
        <td><textarea id="detalleTrabajo" placeholder="Descripción del trabajo realizado"></textarea></td>
        <td><textarea id="valorDetalle" oninput="calcularTotales()" placeholder="&#10;&#10;"></textarea></td>
      </tr>
    </tbody>
  </table>

  <!-- OBS -->
  <div class="seccion-titulo">Obs.</div>
  <textarea id="observaciones" class="textarea-obs" placeholder="Observaciones adicionales..."></textarea>

  <!-- SON -->
  <div class="fila-son">
    <label>Son:</label>
    <input id="son" placeholder="Escribe sin puntos" oninput="formatearSon(this)">
    <span>pesos</span>
  </div>

  <!-- TOTALES -->
  <div class="totales-wrap">
    <div class="totales-col">
      <div class="totales-row">
        <label>Total</label><input id="total" placeholder="Escribe sin puntos" oninput="formatearTotal(this)">
      </div>
      <div class="totales-row">
        <label>Abono</label><input id="abono" placeholder="Escribe sin puntos" oninput="formatearAbono(this)">
      </div>
      <div class="totales-row">
        <label>Saldo</label><input id="saldo" placeholder="Escribe sin puntos" oninput="formatearSaldo(this)">
      </div>
    </div>
  </div>

  <!-- FIRMAS -->
  <div class="firmas">
    <div class="firma-box">
      <div class="firma-linea"></div>
      Firma Proveedor
    </div>
    <div class="firma-box">
      <div class="firma-linea"></div>
      Firma Cliente
    </div>
  </div>

  <div class="nota-pie">NOTA: ESTA ORDEN DE TRABAJO ES VÁLIDA COMO RESPALDO DEL SERVICIO REALIZADO.</div>
</div>

<!-- MODAL DE COINCIDENCIAS -->
<div id="modal-coincidencias">
  <div class="modal-card">
    <h3>OTs anteriores de esta patente</h3>
    <p>Seleccione una OT para cargar sus datos. <strong>El detalle del trabajo se copiará automáticamente.</strong></p>
    
    <div id="cargando-ots" class="cargando">
      <div class="cargando-spinner"></div>
      <p>Buscando OTs anteriores...</p>
    </div>
    
    <ul id="lista-coincidencias"></ul>
    
    <div class="botones-modal">
      <button onclick="cerrarModalCoincidencias()">Cancelar</button>
      <button class="boton-crear-nuevo" onclick="crearNuevaOTDesdeModal()">Crear Nueva OT</button>
    </div>
  </div>
</div>

<!-- BOTONES FLOTANTES -->
<div class="fab">
  <button onclick="mostrarOTsAnteriores()" class="boton-ots-anteriores">OTs anteriores</button>
  <button onclick="irABuscarAceites()" class="boton-aceites">Buscar aceites</button>
  <button onclick="guardarYImprimir()" class="boton-imprimir">Imprimir y Guardar</button>
  <button onclick="borrarTodo()" class="boton-borrar">Borrar Todo</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw6X0uuAlMz-k3PbquHLLFftJyRJJDkxwNPmdYljFSd__jaLu9DAbHufoCcOAhIopf4cw/exec";

// Variables globales
let datosFormularioActual = {};
let registroSeleccionado = null;
let modoNuevoRegistro = true;
let ultimaOTCalculada = "";
let ultimaPatenteBuscada = "";
let modalAbierto = false;
let coincidenciasEncontradas = [];

// ==================== FUNCIONES MEJORADAS ====================

// Función para mostrar OTs anteriores
async function mostrarOTsAnteriores() {
  const patenteInput = document.getElementById("patente");
  const pat = normalizarPatente(patenteInput.value);
  
  if(!pat || pat.length < 3) {
    alert("Por favor ingrese una patente para buscar OTs anteriores");
    patenteInput.focus();
    return;
  }
  
  const cargandoElement = document.getElementById("cargando-ots");
  const listaElement = document.getElementById("lista-coincidencias");
  
  document.getElementById("modal-coincidencias").style.display = "flex";
  modalAbierto = true;
  cargandoElement.style.display = "block";
  listaElement.innerHTML = "";
  
  try {
    setTimeout(async () => {
      try {
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(pat)}&t=${timestamp}`);
        const data = await response.json();

        cargandoElement.style.display = "none";

        if(!data.success || !data.registros || data.registros.length === 0) {
          listaElement.innerHTML = `<li style="text-align: center; padding: 20px; color: #666;">No se encontraron OTs anteriores para la patente ${pat}</li>`;
          return;
        }

        const registrosOrdenados = ordenarRegistrosPorFechaDesc(data.registros);
        coincidenciasEncontradas = registrosOrdenados;
        mostrarRegistrosEnModal(registrosOrdenados);
        
      } catch(error) {
        console.error("Error buscando OTs anteriores:", error);
        cargandoElement.style.display = "none";
        listaElement.innerHTML = `<li style="text-align: center; padding: 20px; color: #dc3545;">Error al buscar OTs anteriores. Intente nuevamente.</li>`;
      }
    }, 0);
    
  } catch(error) {
    console.error("Error inicial:", error);
    cargandoElement.style.display = "none";
    listaElement.innerHTML = `<li style="text-align: center; padding: 20px; color: #dc3545;">Error al buscar OTs anteriores. Intente nuevamente.</li>`;
  }
}

// Función para ordenar registros por fecha descendente
function ordenarRegistrosPorFechaDesc(registros) {
  return registros.sort((a, b) => {
    const fechaA = obtenerFechaComparable(a.Fecha);
    const fechaB = obtenerFechaComparable(b.Fecha);
    return fechaB - fechaA;
  });
}

// Función para convertir fecha a formato comparable
function obtenerFechaComparable(fechaStr) {
  if (!fechaStr) return 0;
  
  try {
    const fecha = new Date(fechaStr);
    if (!isNaN(fecha.getTime())) {
      return fecha.getTime();
    }
    
    const partes = fechaStr.split(/[/ -]/);
    if (partes.length === 3) {
      const dia = parseInt(partes[0]);
      const mes = parseInt(partes[1]) - 1;
      const año = parseInt(partes[2]);
      
      if (!isNaN(dia) && !isNaN(mes) && !isNaN(año)) {
        const fechaAlternativa = new Date(año, mes, dia);
        if (!isNaN(fechaAlternativa.getTime())) {
          return fechaAlternativa.getTime();
        }
      }
    }
    
    return 0;
  } catch (e) {
    return 0;
  }
}

// Función para mostrar registros en el modal - MEJORADA
function mostrarRegistrosEnModal(registros) {
  const lista = document.getElementById("lista-coincidencias");
  lista.innerHTML = "";
  
  registros.forEach((registro, index) => {
    const li = document.createElement("li");
    
    const fecha = registro.Fecha ? 
      (typeof registro.Fecha === 'string' ? registro.Fecha.split(' ')[0] : registro.Fecha) : 
      'Sin fecha';
    
    const ot = registro.OT || registro.OrdenTrabajo || 'N/A';
    const otFormateada = ot !== 'N/A' ? String(ot).padStart(6, "0") : 'N/A';
    const nombre = registro.Nombre || registro.nombre || 'Sin nombre';
    const fuente = registro.Fuente === "Hoja1" ? "Hoja 1 (Reparación)" : "Informe";
    const claseFuente = registro.Fuente === "Hoja1" ? "fuente-hoja1" : "fuente-informe";
    
    // Obtener el trabajo realizado - MEJORADO para asegurar que siempre se encuentre
    let trabajoRealizado = '';
    
    // Buscar en todos los campos posibles
    const posiblesCampos = [
      'DetalleEstado', 'detalle_estado',
      'DetalleTabla', 'detalle_tabla',
      'TrabajoRealizado', 'trabajo_realizado',
      'Detalle', 'detalle',
      'Descripcion', 'descripcion',
      'Observaciones', 'observaciones'
    ];
    
    for (const campo of posiblesCampos) {
      if (registro[campo] && registro[campo].trim()) {
        trabajoRealizado = registro[campo].trim();
        break;
      }
    }
    
    // Truncar si es muy largo para el modal
    const trabajoMostrar = trabajoRealizado.length > 100 ? 
      trabajoRealizado.substring(0, 100) + '...' : trabajoRealizado;
    
    li.className = "coincidencia-item";
    
    // Resaltar si tiene trabajo realizado
    if (trabajoRealizado) {
      li.style.borderLeft = "6px solid #28a745";
      li.style.background = "#f8fff8";
    }
    
    li.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <strong style="font-size: 16px;">OT: ${otFormateada}</strong> 
        <span class="fuente ${claseFuente}">${fuente}</span>
      </div>
      <div style="font-size: 14px; margin-top: 4px; color: #444;">
        <strong>Fecha:</strong> ${fecha}
      </div>
      <div style="font-size: 15px; margin-top: 6px; font-weight: bold;">
        ${nombre}
      </div>
      <div style="font-size: 14px; margin-top: 4px; color: #444;">
        ${registro.Marca || ''} ${registro.Modelo || ''} | ${registro.Patente || registro.patente || ''}
      </div>
      <div style="font-size: 13px; color: #777; margin-top: 3px;">
        <strong>Tel:</strong> ${registro.Telefono || registro.Teléfono || registro.telefono || ''}
      </div>
      ${trabajoMostrar ? `
      <div style="font-size: 13px; color: #555; margin-top: 8px; padding: 8px; background: #f0f8f0; border-radius: 4px; border-left: 4px solid #28a745;">
        <strong style="display: block; margin-bottom: 3px; color: #155724;">Trabajo realizado:</strong> 
        ${trabajoMostrar}
        ${trabajoRealizado.length > 100 ? '<div style="color: #28a745; font-size: 12px; margin-top: 4px;">(Se copiará completo al hacer clic)</div>' : ''}
      </div>
      ` : `
      <div style="font-size: 13px; color: #999; margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; border-left: 4px solid #ccc;">
        <strong style="display: block; margin-bottom: 3px; color: #666;">Trabajo realizado:</strong> 
        <em>Sin información de trabajo realizado</em>
      </div>
      `}
      <div style="margin-top: 8px; padding: 6px; background: #e8f4f8; border-radius: 4px; font-size: 12px; color: #0c5460;">
        <strong>⚠️ Al hacer clic:</strong> Se copiarán TODOS los datos incluyendo el trabajo realizado
      </div>
    `;
    
    // Al hacer clic, cargar los datos y rellenar automáticamente el detalle
    li.onclick = () => {
      cargarDatosDesdeRegistro(registro, true);
      // Resaltar visualmente que esta OT fue seleccionada
      li.style.background = "#e8f4e8";
      li.style.borderColor = "#28a745";
    };
    
    lista.appendChild(li);
  });
  
  // Actualizar texto del botón
  const botonCrearNuevo = document.querySelector('.boton-crear-nuevo');
  if (botonCrearNuevo) {
    botonCrearNuevo.textContent = `Crear Nueva OT (${registros.length} existentes)`;
  }
}

// Función para ir a la página de buscar aceites
function irABuscarAceites() {
  window.open("buscar.html", "_blank");
}

// ==================== FUNCIONES DE FORMATO ====================

// Formatear número con puntos mientras se muestra
function formatearNumeroMostrar(numero) {
  if (!numero) return "";
  let numStr = String(numero).replace(/\./g, '');
  const num = parseInt(numStr) || 0;
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Formatear SON mientras se escribe
function formatearSon(input) {
  const cursorPos = input.selectionStart;
  const valorOriginal = input.value;
  const numeros = valorOriginal.replace(/[^\d]/g, '');
  const formateado = formatearNumeroMostrar(numeros);
  input.value = formateado;
  const nuevoCursorPos = cursorPos + (formateado.length - valorOriginal.length);
  input.setSelectionRange(nuevoCursorPos, nuevoCursorPos);
}

// Formatear TOTAL mientras se escribe
function formatearTotal(input) {
  formatearSon(input);
  setTimeout(calcularSaldo, 10);
}

// Formatear ABONO mientras se escribe
function formatearAbono(input) {
  formatearSon(input);
  setTimeout(calcularSaldo, 10);
}

// Formatear SALDO mientras se escribe
function formatearSaldo(input) {
  formatearSon(input);
}

// Obtener número limpio (sin puntos) para guardar
function obtenerNumeroLimpio(valor) {
  if (!valor) return "0";
  const limpio = String(valor).replace(/\./g, '');
  return parseInt(limpio) || 0;
}

// Calcular totales desde la tabla de detalles
function calcularTotales() {
  const cantDetalle = document.getElementById('cantDetalle').value;
  const valorDetalle = document.getElementById('valorDetalle').value;
  const sonInput = document.getElementById('son');
  const totalInput = document.getElementById('total');
  
  if (cantDetalle.trim() && valorDetalle.trim()) {
    const cantidades = cantDetalle.split('\n').map(line => {
      const num = parseFloat(line.replace(/\./g, '').replace(',', '.'));
      return isNaN(num) ? 0 : num;
    });
    
    const valores = valorDetalle.split('\n').map(line => {
      const num = parseFloat(line.replace(/\./g, '').replace(',', '.'));
      return isNaN(num) ? 0 : num;
    });
    
    let sumatoria = 0;
    const minLength = Math.min(cantidades.length, valores.length);
    
    for (let i = 0; i < minLength; i++) {
      sumatoria += cantidades[i] * valores[i];
    }
    
    const totalRedondeado = Math.round(sumatoria);
    totalInput.value = formatearNumeroMostrar(totalRedondeado);
    sonInput.value = formatearNumeroMostrar(totalRedondeado);
    
    calcularSaldo();
  }
}

// Calcular saldo automáticamente
function calcularSaldo() {
  const totalInput = document.getElementById('total');
  const abonoInput = document.getElementById('abono');
  const saldoInput = document.getElementById('saldo');
  
  const total = obtenerNumeroLimpio(totalInput.value);
  const abono = obtenerNumeroLimpio(abonoInput.value);
  
  if (!saldoInput.dataset.editadoManual) {
    const saldo = total - abono;
    saldoInput.value = formatearNumeroMostrar(Math.max(0, saldo));
  }
}

// Marcar que el saldo fue editado manualmente
document.getElementById('saldo').addEventListener('input', function() {
  this.dataset.editadoManual = 'true';
});

// Formatear teléfono para guardar
function formatearTelefonoParaGuardar(telefono) {
  if (!telefono) return "";
  
  let tel = String(telefono).trim();
  const soloNumeros = tel.replace(/[^0-9]/g, '');
  
  if (!soloNumeros) return "";
  
  if (soloNumeros.startsWith('56') && soloNumeros.length === 11) {
    return soloNumeros.substring(2);
  }
  
  if (soloNumeros.startsWith('9') && soloNumeros.length === 9) {
    return soloNumeros;
  }
  
  if (soloNumeros.length === 8) {
    return '9' + soloNumeros;
  }
  
  return soloNumeros;
}

// ==================== FUNCIONES PRINCIPALES ====================

// Inicialización
function setFechaHoy(){
  const hoy = new Date();
  const fechaFormateada = hoy.toLocaleDateString("es-CL");
  document.getElementById("fechaHoy").textContent = fechaFormateada;
}

// Obtener la siguiente OT
async function cargarSiguienteOT(){
  try{
    const timestamp = new Date().getTime();
    
    const [rHoja1, rInforme] = await Promise.all([
      fetch(`${API_URL}?t=${timestamp}`),
      fetch(`${API_URL}?action=obtenerSiguienteOT&t=${timestamp}`)
    ]);
    
    let maxOT = 0;
    
    if (rHoja1.ok) {
      const dataHoja1 = await rHoja1.json();
      if (Array.isArray(dataHoja1)) {
        dataHoja1.forEach(item => {
          if (item.OrdenTrabajo) {
            const ot = parseInt(item.OrdenTrabajo);
            if (!isNaN(ot) && ot > maxOT) {
              maxOT = ot;
            }
          }
        });
      }
    }
    
    if (rInforme.ok) {
      const dataInforme = await rInforme.json();
      if (dataInforme.success && dataInforme.nextOT) {
        const otInforme = parseInt(dataInforme.nextOT.replace(/^0+/, '')) - 1;
        if (!isNaN(otInforme) && otInforme > maxOT) {
          maxOT = otInforme;
        }
      }
    }
    
    const nextOT = String(maxOT + 1).padStart(6, "0");
    document.getElementById("otNumero").textContent = nextOT;
    ultimaOTCalculada = nextOT;
    
    return nextOT;
    
  }catch(e){
    console.error("Error cargando OT:", e);
    document.getElementById("otNumero").textContent = "—";
    return "000001";
  }
}

// Normalizar patente
function normalizarPatente(p){
  return (p||"").toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
}

// Buscar patente
async function buscarPorPatente(){
  const patenteInput = document.getElementById("patente");
  const pat = normalizarPatente(patenteInput.value);
  
  if(!pat || pat.length < 3) {
    modoNuevoRegistro = true;
    registroSeleccionado = null;
    return;
  }
  
  if (pat === ultimaPatenteBuscada && registroSeleccionado) {
    return;
  }
  
  if (modalAbierto) {
    return;
  }
  
  try{
    const timestamp = new Date().getTime();
    const response = await fetch(`${API_URL}?action=buscarPorPatente&patente=${encodeURIComponent(pat)}&t=${timestamp}`);
    const data = await response.json();

    if(!data.success || !data.registros || data.registros.length === 0) {
      modoNuevoRegistro = true;
      registroSeleccionado = null;
      ultimaPatenteBuscada = pat;
      limpiarDetallesInforme();
      await cargarSiguienteOT();
      return;
    }

    ultimaPatenteBuscada = pat;
    
    if(data.registros.length === 1){
      cargarDatosDesdeRegistro(data.registros[0], false);
      return;
    }
    
    coincidenciasEncontradas = data.registros;
    guardarDatosFormularioActual();
    mostrarModalCoincidencias(data.registros);
    
  }catch(error){
    console.error("Error buscando patente:", error);
  }
}

// Guardar datos actuales del formulario
function guardarDatosFormularioActual(){
  datosFormularioActual = {
    nombre: document.getElementById("nombreCliente").value,
    telefono: document.getElementById("telefono").value,
    direccion: document.getElementById("direccion").value,
    marca: document.getElementById("marca").value,
    modelo: document.getElementById("modelo").value,
    km: document.getElementById("km").value,
    patente: document.getElementById("patente").value
  };
}

// Limpiar campos de detalles del informe
function limpiarDetallesInforme(){
  if(modoNuevoRegistro){
    document.getElementById("detalleTrabajo").value = "";
    document.getElementById("observaciones").value = "";
    document.getElementById("son").value = "";
    document.getElementById("total").value = "";
    document.getElementById("abono").value = "";
    document.getElementById("saldo").value = "";
    document.getElementById("cantDetalle").value = "";
    document.getElementById("valorDetalle").value = "";
    document.getElementById('saldo').removeAttribute('data-editado-manual');
  }
}

// ==================== FUNCIÓN MEJORADA PARA CARGAR DATOS ====================

// MODIFICADA Y MEJORADA: Cargar datos desde un registro seleccionado
function cargarDatosDesdeRegistro(registro, desdeModal = false){
  registroSeleccionado = registro;
  modoNuevoRegistro = false;
  
  console.log("Cargando registro:", registro);
  
  // Campos básicos
  document.getElementById("nombreCliente").value = registro.Nombre || registro.nombre || "";
  document.getElementById("telefono").value = registro.Telefono || registro.Teléfono || registro.telefono || "";
  document.getElementById("direccion").value = registro.Direccion || registro.Dirección || "";
  document.getElementById("marca").value = registro.Marca || "";
  document.getElementById("modelo").value = registro.Modelo || "";
  document.getElementById("km").value = registro.Kilometraje || registro.KM || "";
  
  // Obtener OT del registro
  let otRegistro = "";
  if(registro.Fuente === "DatosInforme"){
    otRegistro = registro.OT || "";
    
    // PARA INFORMES: Usar DetalleTabla para el campo detalle
    let detalleTrabajo = registro.DetalleTabla || registro.detalle_tabla || "";
    
    // Si no hay en DetalleTabla, buscar en otros campos
    if (!detalleTrabajo) {
      detalleTrabajo = registro.TrabajoRealizado || registro.trabajo_realizado || 
                       registro.Detalle || registro.detalle || 
                       registro.Descripcion || registro.descripcion || "";
    }
    
    document.getElementById("detalleTrabajo").value = detalleTrabajo;
    document.getElementById("observaciones").value = registro.Observaciones || "";
    
    // Formatear números para mostrar
    if(registro.Son) document.getElementById("son").value = formatearNumeroMostrar(registro.Son);
    if(registro.Total) document.getElementById("total").value = formatearNumeroMostrar(registro.Total);
    if(registro.Abono) document.getElementById("abono").value = formatearNumeroMostrar(registro.Abono);
    if(registro.Saldo) {
      document.getElementById("saldo").value = formatearNumeroMostrar(registro.Saldo);
      document.getElementById('saldo').dataset.editadoManual = 'true';
    }
    
  }else if(registro.Fuente === "Hoja1"){
    otRegistro = registro.OrdenTrabajo || "";
    
    // PARA HOJA1: Buscar en TODOS los campos posibles el trabajo realizado
    let trabajoRealizado = "";
    
    // Lista de campos donde podría estar el trabajo realizado
    const camposPosibles = [
      'DetalleEstado', 'detalle_estado',
      'TrabajoRealizado', 'trabajo_realizado',
      'Detalle', 'detalle',
      'Descripcion', 'descripcion',
      'Observaciones', 'observaciones'
    ];
    
    for (const campo of camposPosibles) {
      if (registro[campo] && registro[campo].trim()) {
        trabajoRealizado = registro[campo].trim();
        break;
      }
    }
    
    // SIEMPRE rellenar el detalle si hay trabajo realizado
    if (trabajoRealizado) {
      document.getElementById("detalleTrabajo").value = trabajoRealizado;
      
      // Resaltar visualmente que se copió el detalle
      resaltarDetalleCopiado();
      
      // Mostrar mensaje si viene desde el modal
      if (desdeModal) {
        mostrarMensajeExito("✅ El trabajo realizado se ha copiado al campo Detalle");
      }
    } else {
      // Si no hay trabajo realizado, limpiar el detalle
      document.getElementById("detalleTrabajo").value = "";
      if (desdeModal) {
        mostrarMensajeExito("⚠️ Esta OT no tiene información de trabajo realizado", "warning");
      }
    }
    
    // Limpiar otros campos que no corresponden a Hoja1
    document.getElementById("observaciones").value = "";
    document.getElementById("son").value = "";
    document.getElementById("total").value = "";
    document.getElementById("abono").value = "";
    document.getElementById("saldo").value = "";
    document.getElementById("cantDetalle").value = "";
    document.getElementById("valorDetalle").value = "";
    document.getElementById('saldo').removeAttribute('data-editado-manual');
  }
  
  // Establecer la OT si la patente coincide
  const patenteActual = normalizarPatente(document.getElementById("patente").value);
  const patenteRegistro = normalizarPatente(registro.Patente || registro.patente || "");
  
  if(patenteActual === patenteRegistro && otRegistro){
    const otFormateada = String(otRegistro).padStart(6, "0");
    document.getElementById("otNumero").textContent = otFormateada;
    console.log("OT establecida desde registro:", otFormateada);
  }
  
  cerrarModalCoincidencias();
  
  // Enfocar el campo detalle si se copió algo
  if (document.getElementById("detalleTrabajo").value.trim()) {
    setTimeout(() => {
      document.getElementById("detalleTrabajo").focus();
    }, 300);
  }
}

// Función para resaltar visualmente que se copió el detalle
function resaltarDetalleCopiado() {
  const detalleTextarea = document.getElementById("detalleTrabajo");
  detalleTextarea.classList.add("detalle-copiado");
  
  // Quitar el resaltado después de 3 segundos
  setTimeout(() => {
    detalleTextarea.classList.remove("detalle-copiado");
  }, 3000);
}

// Función para mostrar mensaje de éxito
function mostrarMensajeExito(mensaje, tipo = "success") {
  const mensajeElement = document.getElementById("mensajeExito");
  mensajeElement.textContent = mensaje;
  
  if (tipo === "warning") {
    mensajeElement.style.background = "#ffc107";
    mensajeElement.style.color = "#212529";
  } else {
    mensajeElement.style.background = "#28a745";
    mensajeElement.style.color = "white";
  }
  
  mensajeElement.style.display = "block";
  
  // Ocultar después de 3 segundos
  setTimeout(() => {
    mensajeElement.style.display = "none";
  }, 3000);
}

// Función para mostrar modal con coincidencias
function mostrarModalCoincidencias(registros){
  const registrosOrdenados = ordenarRegistrosPorFechaDesc(registros);
  const lista = document.getElementById("lista-coincidencias");
  lista.innerHTML = "";
  
  document.getElementById("cargando-ots").style.display = "none";
  
  registrosOrdenados.forEach((registro, index) => {
    const li = document.createElement("li");
    
    const fecha = registro.Fecha ? 
      (typeof registro.Fecha === 'string' ? registro.Fecha.split(' ')[0] : registro.Fecha) : 
      'Sin fecha';
    
    const ot = registro.OT || registro.OrdenTrabajo || 'N/A';
    const otFormateada = ot !== 'N/A' ? String(ot).padStart(6, "0") : 'N/A';
    const nombre = registro.Nombre || registro.nombre || 'Sin nombre';
    const fuente = registro.Fuente === "Hoja1" ? "Hoja 1 (Reparación)" : "Informe";
    const claseFuente = registro.Fuente === "Hoja1" ? "fuente-hoja1" : "fuente-informe";
    
    let trabajoRealizado = '';
    const camposPosibles = [
      'DetalleEstado', 'detalle_estado',
      'DetalleTabla', 'detalle_tabla',
      'TrabajoRealizado', 'trabajo_realizado',
      'Detalle', 'detalle',
      'Descripcion', 'descripcion'
    ];
    
    for (const campo of camposPosibles) {
      if (registro[campo] && registro[campo].trim()) {
        trabajoRealizado = registro[campo].trim();
        break;
      }
    }
    
    const trabajoMostrar = trabajoRealizado.length > 100 ? 
      trabajoRealizado.substring(0, 100) + '...' : trabajoRealizado;
    
    li.className = "coincidencia-item";
    
    if (trabajoRealizado) {
      li.style.borderLeft = "6px solid #28a745";
      li.style.background = "#f8fff8";
    }
    
    li.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <strong style="font-size: 16px;">OT: ${otFormateada}</strong> 
        <span class="fuente ${claseFuente}">${fuente}</span>
      </div>
      <div style="font-size: 14px; margin-top: 4px; color: #444;">
        <strong>Fecha:</strong> ${fecha}
      </div>
      <div style="font-size: 15px; margin-top: 6px; font-weight: bold;">
        ${nombre}
      </div>
      <div style="font-size: 14px; margin-top: 4px; color: #444;">
        ${registro.Marca || ''} ${registro.Modelo || ''} | ${registro.Patente || registro.patente || ''}
      </div>
      <div style="font-size: 13px; color: #777; margin-top: 3px;">
        <strong>Tel:</strong> ${registro.Telefono || registro.Teléfono || registro.telefono || ''}
      </div>
      ${trabajoMostrar ? `
      <div style="font-size: 13px; color: #555; margin-top: 8px; padding: 8px; background: #f0f8f0; border-radius: 4px; border-left: 4px solid #28a745;">
        <strong style="display: block; margin-bottom: 3px; color: #155724;">Trabajo realizado:</strong> 
        ${trabajoMostrar}
        ${trabajoRealizado.length > 100 ? '<div style="color: #28a745; font-size: 12px; margin-top: 4px;">(Se copiará completo)</div>' : ''}
      </div>
      ` : `
      <div style="font-size: 13px; color: #999; margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; border-left: 4px solid #ccc;">
        <strong style="display: block; margin-bottom: 3px; color: #666;">Trabajo realizado:</strong> 
        <em>Sin información de trabajo realizado</em>
      </div>
      `}
    `;
    
    li.onclick = () => cargarDatosDesdeRegistro(registro, true);
    lista.appendChild(li);
  });
  
  const botonCrearNuevo = document.querySelector('.boton-crear-nuevo');
  if (botonCrearNuevo) {
    botonCrearNuevo.textContent = `Crear Nueva OT (${registros.length} existentes)`;
  }
  
  document.getElementById("modal-coincidencias").style.display = "flex";
  modalAbierto = true;
}

// Cerrar modal
function cerrarModalCoincidencias(){
  document.getElementById("modal-coincidencias").style.display = "none";
  modalAbierto = false;
  coincidenciasEncontradas = [];
}

// Crear nueva OT desde el modal
function crearNuevaOTDesdeModal(){
  const datosVehiculo = obtenerDatosVehiculoDesdeCoincidencias();
  const patenteActual = document.getElementById("patente").value.trim();
  
  document.getElementById("marca").value = datosVehiculo.marca || "";
  document.getElementById("modelo").value = datosVehiculo.modelo || "";
  
  if (datosVehiculo.patente && !patenteActual) {
    document.getElementById("patente").value = datosVehiculo.patente;
  }
  
  document.getElementById("nombreCliente").value = "";
  document.getElementById("telefono").value = "";
  document.getElementById("direccion").value = "";
  document.getElementById("km").value = "";
  
  modoNuevoRegistro = true;
  registroSeleccionado = null;
  
  cargarSiguienteOT();
  limpiarDetallesInforme();
  
  mostrarMensajeExito("✅ Nueva OT creada. Complete los datos del nuevo dueño.");
  
  cerrarModalCoincidencias();
  
  setTimeout(() => {
    document.getElementById("nombreCliente").focus();
  }, 300);
}

// Obtener datos del vehículo desde coincidencias
function obtenerDatosVehiculoDesdeCoincidencias() {
  if (!coincidenciasEncontradas || coincidenciasEncontradas.length === 0) {
    return { marca: "", modelo: "", patente: "" };
  }
  
  const primerRegistro = coincidenciasEncontradas[0];
  
  return {
    marca: primerRegistro.Marca || "",
    modelo: primerRegistro.Modelo || "",
    patente: primerRegistro.Patente || primerRegistro.patente || ""
  };
}

// Recolectar datos para guardar
function recogerDatos(){
  const telefonoInput = document.getElementById("telefono").value.trim();
  const telefonoFormateado = formatearTelefonoParaGuardar(telefonoInput);
  
  return {
    funcion: "guardar_informe",
    OT: document.getElementById("otNumero").textContent.trim(),
    Fecha: new Date().toISOString().split('T')[0],
    nombre: document.getElementById("nombreCliente").value.trim(),
    telefono: telefonoFormateado,
    direccion: document.getElementById("direccion").value.trim(),
    marca: document.getElementById("marca").value.trim(),
    modelo: document.getElementById("modelo").value.trim(),
    patente: normalizarPatente(document.getElementById("patente").value),
    km: document.getElementById("km").value.trim(),
    detalle_tabla: document.getElementById("detalleTrabajo").value.trim(),
    obs: document.getElementById("observaciones").value.trim(),
    son: obtenerNumeroLimpio(document.getElementById("son").value).toString(),
    total: obtenerNumeroLimpio(document.getElementById("total").value).toString(),
    abono: obtenerNumeroLimpio(document.getElementById("abono").value).toString(),
    saldo: obtenerNumeroLimpio(document.getElementById("saldo").value).toString()
  };
}

// Guardar e imprimir
async function guardarYImprimir(){
  const datos = recogerDatos();
  
  if(!datos.patente || datos.patente.length < 3){
    alert("Por favor ingrese una patente válida");
    return;
  }
  
  try{
    const formData = new URLSearchParams();
    for (const key in datos) {
      formData.append(key, datos[key]);
    }
    
    const response = await fetch(API_URL, {
      method: "POST",
      mode: 'no-cors',
      headers: { 
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: formData.toString()
    });
    
    alert(`✅ Informe guardado\n\nOT: ${datos.OT}\nCliente: ${datos.nombre}\nTeléfono: ${datos.telefono}\nPatente: ${datos.patente}\n\nLos números se guardaron sin puntos.`);
    
    setTimeout(async () => {
      await cargarSiguienteOT();
    }, 1000);
    
    setTimeout(() => {
      window.print();
    }, 500);
    
    modoNuevoRegistro = true;
    registroSeleccionado = null;
    ultimaPatenteBuscada = "";
    
    document.getElementById("detalleTrabajo").value = "";
    document.getElementById("observaciones").value = "";
    document.getElementById("son").value = "";
    document.getElementById("total").value = "";
    document.getElementById("abono").value = "";
    document.getElementById("saldo").value = "";
    document.getElementById("cantDetalle").value = "";
    document.getElementById("valorDetalle").value = "";
    document.getElementById('saldo').removeAttribute('data-editado-manual');
    
  }catch(error){
    console.error("Error guardando:", error);
    alert("⚠️ Se produjo un error al guardar, pero puedes imprimir el informe.");
    window.print();
  }
}

// Borrar todo el formulario
function borrarTodo(){
  if(!confirm("¿Está seguro de borrar todos los datos del formulario?")) return;
  
  const campos = [
    "nombreCliente", "telefono", "direccion", "marca", 
    "patente", "km", "modelo", "cantDetalle", "detalleTrabajo", 
    "valorDetalle", "observaciones", "son", "total", "abono", "saldo"
  ];
  
  campos.forEach(id => {
    const element = document.getElementById(id);
    if(element) element.value = "";
  });
  
  modoNuevoRegistro = true;
  registroSeleccionado = null;
  ultimaPatenteBuscada = "";
  
  cargarSiguienteOT();
  setFechaHoy();
  
  document.getElementById('saldo').removeAttribute('data-editado-manual');
  
  console.log("Formulario borrado, modo nuevo registro activado");
}

// Función para verificar y actualizar OT automáticamente
function verificarYActualizarOT(){
  const patente = document.getElementById("patente").value.trim();
  if(modoNuevoRegistro && (!patente || patente.length < 3)){
    cargarSiguienteOT();
  }
}

// ==================== EVENT LISTENERS ====================

let timeoutBusqueda = null;

document.getElementById("patente").addEventListener("input", function(){
  if (timeoutBusqueda) {
    clearTimeout(timeoutBusqueda);
  }
  
  timeoutBusqueda = setTimeout(() => {
    if(this.value.trim().length >= 3){
      modoNuevoRegistro = true;
      registroSeleccionado = null;
      buscarPorPatente();
    }
  }, 500);
});

document.getElementById("patente").addEventListener("blur", function(){
  if(this.value.trim().length >= 3){
    buscarPorPatente();
  }
});

// Evento para actualizar fecha cada minuto
setInterval(() => {
  setFechaHoy();
}, 60000);

// Verificar OT periódicamente
setInterval(() => {
  if(modoNuevoRegistro){
    verificarYActualizarOT();
  }
}, 30000);

// Inicializar al cargar
window.onload = () => {
  setFechaHoy();
  cargarSiguienteOT();
  console.log("Página cargada, modo nuevo registro activado");
  
  setTimeout(() => {
    verificarYActualizarOT();
  }, 1000);
};
</script>

</body>
</html>
<script async data-explicit-opt-in="true" data-cookie-opt-in="true" data-deployment-id="dpl_5AxoMPpvdCKwGboCvgPcq1YskMoZ" src="https://vercel.live/_next-live/feedback/feedback.js"></script>